# Modified main location block to ensure middleware runs
# Replace the existing "location /" block with this:

# Main location - ALWAYS proxy HTML requests to Nuxt for middleware
location / {
    # For HTML pages, always go through Nuxt (to trigger middleware)
    if ($request_filename ~* \.(html)$) {
        proxy_pass http://127.0.0.1:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        break;
    }
    
    # For paths without extensions (routes), always proxy to Nuxt
    if ($uri !~ \.) {
        proxy_pass http://127.0.0.1:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        break;
    }
    
    # For everything else, try static files first
    try_files $uri @nuxt;
}